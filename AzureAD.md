# AzureAD PowerShell Module
To manage Azure AD
Doesn't show all the properties of AzureAD objects and the documentation is not good. 

- [Install](#Install)
- [Enumeration Users](#Enumeration_Users)
- [Enumeration Groups](#Enumeration_Groups)
- [Enumeration Roles](#Enumeration_Roles)
- [Enumeration Devices](#Enumeration_Devices)
- [Enumeration Apps](#Enumeration_Apps)
- [Enumeration Service Principals](#Enumeration_Service_Principals)
- [Using Tokens With AzureAD](#Using_Tokens_With_AzureAD) 



# Install
**Needs Internet Connection**
```powershell
Install-Module AzureAD
```
or 
- Download it from Powershell Gallery https://www.powershellgallery.com/packages/AzureAD
- Rename the `.nukpkg` to `.zip` and extract it
- Import as module
	```powershell
	Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
	```

**Enumeration - AzureAD Module**
- To be able to use PowerShell module, we must connect to Azure AD first:
```powershell
Connect-AzureAD
$creds = Get-Credential
Connect-AzureAD -Credential $creds

$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -asPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
```

- Get the current session state
```powershell
Get-AzureADCurrentSessionInfo
```
- Get details of the current tenant
```powershell
Get-AzureADTenantDetail
```

# Enumeration_Users 
- Enumerate all users
```powershell
Get-AzureADUser -All $true
```
- Enumerate specific user
```powershell
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com
```
- Search for a user based on string in first characters of DisplayName or `userPrincipalName` 
```powershell
Get-AzureADUser -SearchString "admin"
```
- Search for users who contain the word "admin" in their Display name:
```powershell
Get-AzureADUser -All $true | ?{$_.Displayname -match "admin"}
```
- List all the attributes for a user
```powershell
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | fl *
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | %{$_.PSObject.Properties.Name}
```
Search attributes for all users that contain the string "password":
```powershell
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
```

- All users who are synced from on-prem
```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```
- All users who are from Azure AD
```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```
- Objects created by any user (use `-ObjectId` for a specific user)
```powershell
Get-AzureADUser | Get-AzureADUserCreatedObject
```
- Objects owned by a specific user
```powershell
Get-AzureADUserOwnedObject -ObjectId test@defcorphq.onmicrosoft.com
```
# Enumeration_Groups
- List all groups
```powershell
Get-AzureADGroup -All $true
```
- Enumerate a specific group
```powershell
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```
- Search for a group based on string in the first characters of DisplayName 
```powershell
Get-AzureADGroup -SearchString "admin" | fl *
```
- To search for groups which contain the word "admin" in their name:
```powershell
Get-AzureADGroup -All $true | ?{$_.DisplayName -match "admin"}
```
- Get groups that allow Dynamic membership (Note the cmdlet name)
```powershell
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
```
- Add a user as a member of to a group `-ObjectID` and `-RefObjectId` are required.
```powershell
Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-
84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
```
- All groups that are synced from on-prem  (security groups are not synced)
```powershell
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```
- All groups that are from Azure AD
```powershell
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```
- Get members of a group
```powershell
Get-AzureADGroupMember -ObjectId 783a312d-0de2-4490- 92e4-539b0e4ee03e
```
- Get groups and roles where the specified user is a member
```powershell
Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership
Get-AzureADUserMembership -ObjectId test@defcorphq.onmicrosoft.com
```
# Enumeration_Roles
- Get all available role templates
```powershell
Get-AzureADDirectoryroleTemplate
```
- Get all enabled roles (a user is assigned the role at least once)
```powershell
Get-AzureADDirectoryRole
```
- Enumerate users to whom roles are assigned
```powershell
Get-AzureADDirectoryRole -Filter "DisplayName -eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```
# Enumeration_Devices
- Get all Azure joined and registered devices
```powershell
Get-AzureADDevice -All $true | fl *
```
- Get the device configuration object ( the RegistrationQuota in the output)
```powershell
Get-AzureADDeviceConfiguration | fl *
```
- List registered owners of all the devices
```powershell
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
```
- List registered users of all the devices
```powershell
Get-AzureADDevice -All $true | Get-AzureDeviceRegisteredUser
```
- List devices owned by a user
```powershell
Get-AzureADUserOwnedDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```
- List devices registered by a user
```powershell
Get-AzureADUserRegisteredDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```
- List devices managed using Intune
```powershell
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
```
# Enumeration_Apps
- Get all the application objects registered with the current tenant
```powershell
Get-AzureADApplication -All $true
```
- Get all details about an application
```powershell
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145- 155a069ebed0 | fl *
```
- Get an application based on the display name
```powershell
Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}
```
- Show the applications with an application password 
```powershell
Get-AzureADApplicationPasswordCredential
```
- Get owner of an application
```powershell
Get-AzureADApplication -ObjectID a1333e88-1278-41bf8145-155a069ebed0 | Get-AzureADApplicationOwner |fl *
```
- Get apps where a user has a role 
```powershell
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | GetAzureADUserAppRoleAssignment | fl *
```
Get apps where a group has a role
```powershell
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4- 539b0e4ee03e | Get-AzureADGroupAppRoleAssignment | fl *
```
# Enumeration_Service_Principals
Enumerate Service Principals (visible as Enterprise Applications in Azure Portal) **Service Account**
- Get all service principals
```powershell
Get-AzureADServicePrincipal -All $true
```
- Get all details about a service principal
```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45- 053e7c37a264 | fl *
```
- Get an service principal based on the display name
```powershell
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"}
```
- Get owner of a service principal
```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45- 053e7c37a264 | Get-AzureADServicePrincipalOwner |fl *
```
- Get object owned by a service principal
```powershell
Get-AzureADServicePrincipal -ObjectID cdddd16e-2611-4442-8f45- 053e7c37a264 | Get-AzureADServicePrincipalOwnedObject
```
- Get objects created by a service principal
```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45- 053e7c37a264 | Get-AzureADServicePrincipalCreatedObject
```
- Get group and role memberships of a service principal
```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611- 4442-8f45-053e7c37a264 | GetAzureADServicePrincipalMembership |fl *
Get-AzureADServicePrincipal | GetAzureADServicePrincipalMembership
```
# Using_Tokens_With_AzureAD 
- AzureAD module can't request a token but can use one for AADGraph or Microsoft Graph
- Use the AAD Graph token;
```powershell
Connect-AzureAD -AccountId test@defcorphq.onmicrosoft.com -AadAccessToken eyJ0XA....
```

