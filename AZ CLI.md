# Az CLI  
**Creates and manages Azure resources**

- [Install Az CLI](#Install)
- [Enumeration - Az CLI](#Enumeration)
- [Enumeration AAD Users](#Enumearation_AAD_Users)
- [Enumeration AAD Groups](#Enumearation_AAD_Groups)
- [Enumeration AAD Apps](#Enumearation_AAD_Apps)
- [Enumeration AAD Principals](#Enumearation_AAD_Service_Principals)
- [Using Tokens with Az CLI](#Using_Tokens_with_Az_CLI)
- [Stealing Tokens From Az CLI](#Stealing_Tokens_From_Az_CLI)
- [Automation Extension](#Automation_Extension)

# Install
Can be installed on multiple platforms and can be user with multiple clouds

Install Az Cli as MSI https://docs.microsoft.com/en-us/cli/azure/install-azure-cli



# Enumeration 
```powershell
az login
az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
```
- If the user has no permissions on the subscription
```powershell
az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234 --allow-no-subscriptions
```
- You can configure az cli to some default behaviour (output type, location, resource group etc.)
```powershell
az configure
```
- Find commands in Az CLI
```powershell
az find "vm"
az find "az vm"
az find "az vm list"
```
- List all users in Azure AD and format output in table
```powershell
az ad user list --output table
```
- List all the userPrincipalName and givenName (case sensitive) for all the users in Azure AD
```powershell
az ad user list --query "[].[userPrincipalName,displayName]" --output table
```
- List for objects owned by user.
```powershell
az ad signed-in-user list-owned-objects
```
- List only the userPrincipalName and givenName for all the users, Azure AD, rename the properties and format output in table
```powershell
az ad user list --query "[].{UPN:userPrincipalName, Name:displayName}" --output table
```
- JMESPath query on the results of JSON output.
```powershell
az ad user show list --query-examples
```
- Get details of the current tenant 
```powershell
az account tenant list
```
- Get details of the current subscription 
```powershell
az account subscription list
```
- List the current signed-in user
```powershell
az ad signed-in-user show
```
# Enumearation_AAD_Users
- Enumerate all users
```powershell
az ad user list
az ad user list --query "[].[displayName]" -o table
```
- Enumerate a specific user (list all attributes)
```powershell
az ad user show --id test@defcorphq.onmicrosoft.com
```
- Search for users who contain the word "admin" in their display name 
```powershell
az ad user list --query "[?contains(displayName, 'admin')].displayName"
```
- Search for users who contain the word "admin" in their DisplayName.
```powershell
az ad user list | ConvertFrom-Json | %{$_.displayName -match "admin"}
```
- All users who are synced from on-prem
```powershell
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
```
- All users who are from Azure AD
```powershell
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
```
# Enumearation_AAD_Groups
- List all groups
```powershell
az ad group list 
az ad group list --query "[].[displayName]" -o table
```
- Enumerate a specific group using display name or object id
```powershell
az ad group show -g "VM Admins"
az ad group show -g 783a312d-0de2-4490-92e4-539b0e4ee03e
```
- Search for groups that contain the word "admin" in their displayname -- run from cmd
```powershell
az ad group list --query "[?contains(displayName,'admin')].displayName"
```
- Search for groups that contain the word "admin"
```powershell
az ad group list | ConvertFrom-Json | %{$_.displayName -match "admin"}
```
- All groups that are synced from on-prem
```powershell
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
```
- All groups that are from Azure AD
```powershell
az ad group list --query "?onPremisesSecurityIdentifier==null],displayName"
```
- Get members of a group
```powershell
az ad group member list -g "VM Admins" --query "[].[displayName]" -o table
```
- Check if a user is member of the specific group
```powershell
az ad group member check --group "VM Admins" --member-id b71d21f6-8e09-4a9d-932a-cb73df519787
```
- Get the object IDs of the groups of which the specified group is a member
```powershell
az ad group get-member-groups -g "VM Admins"
```
# Enumearation_AAD_Apps
```powershell
az ad app list
az ad app list --query "[].[displayName]" -o table
```

- Get all details about an application using identifier uri, applcation id or object id
```powershell
az ad show --id b71d21f6-8e09-4a9d-932a-cb73df519787
```
- Get an application based on the display name -- Run from cmd
```powershell
az ad app list | ConvertFrom-Json | %{$_.displayName -match "app"}
```
- Get owner of an application
```powershell
az ad app owner list --id b71d21f6-8e09-4a9d-932a-cb73df519787 --query "[].[displayName]" -o table
```
- List apps that have password credentials
```powershell
az ad app list --query "[?passwordCredentials !=null].displayName"
```
- List apps that have key credentials
```powershell
az ad app list --query "[?keyCredentials !=null].displayName"
```
# Enumearation_AAD_Service_Principals
- List all service principals
```powershell
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
```
- Get all details about a service principal using service principal id or object id 
```powershell
az ad sp list --id b71d21f6-8e09-4a9d-932a-cb73df519787
```
- Get a service principal based on the display name
```powershell
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
```
- Search fo service principals that contain the word "slack" in their display name.
```powershell
az ad sp list --all | ConvertFrom-Json | %{$_.displayName -match "app"}
```
- Get owner of a service principal
```powershell
az ad sp owner list --id b71d21f6-8e09-4a9d-932a-cb73df519787 --query "[].[displayName]" -o table
```
- Get service principals owned by the current user
```powershell
az ad sp list --show-mine
```
- List apps that have password credentials
-```powershell
az ad sp list --all --query "[?passwordCredentials !=null].displayName"
```
- List apps that have key credentials
```powershell
az ad sp list -all --query "[?keyCredentials !=null].displayName"
```
# Using_Tokens_with_Az_CLI
**Az CLI can request a token but cannot use it!**
- Reguest an access token (ARM)
```powershell
az account get-access-token
```
- Request an access token for aad-graph. Supported tokens `aad-graph` `arm` `batch` `data-lake` `media` `ms-graph` `oss-rdbms` 
```powershell
az account get-access-token --resource-type ms-graph
az account get-access-token --resource-type aad-graph
```
# Stealing_Tokens_From_Az_CLI
- Az cli stores access tokens in clear text in accessTokens.json in the directory;
- We can read tokens from the file, use them and request new ones too!
```powershell
C:\Users\[username]\.Azure
```
In this folder `azureProfile.json` contains information about subscriptions.
- You have to clear access tokens, always use with;
```powershell
az logout
```
# Automation_Extension
```powershell
az automation account list
az extension add --upgrade -n automation
```


# Az Cli 
***Login via Az cli***
```powershell
az login -u test@defcorphq.onmicrosoft.com -p SuperS3Cr31PAssw0rd!@l33t
```

***List all VMs***
```powershell
az vm list
az vm list --query "[].[name]" -o table
```

***List all App Services***
```powershell
az webapp list
az webapp list --query "[].[name]" -o table
```
***List Function Apps***
```powershell
az functionapp list --query "[].[name]" -o table
```


***List Storage Accounts***
```powershell
az storage account list
```

***List keyvaults***
```powershell
az keyvault list
```